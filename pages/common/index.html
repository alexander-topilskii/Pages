<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Каталог: цензура, этика и политика в науке</title>
    <style>
        :root{
          --bg:#0b0f14; --panel:#0f1620; --card:#111a26; --muted:#93a4b4; --text:#e8eef5; --acc:#6fb1ff; --chip:#213043; --ok:#9be37a; --warn:#ffd66f; --danger:#ff8a8a;
          --radius:14px; --pad:18px; --shadow:0 10px 30px rgba(0,0,0,.35)
        }
        *{box-sizing:border-box}
        html,body{height:100%}
        body{margin:0; font:16px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif; background:linear-gradient(180deg, #08101a, #0b1119 50%, #0a0f16); color:var(--text)}

        header{position:sticky; top:0; z-index:5; backdrop-filter:saturate(1.2) blur(10px); background:linear-gradient(180deg, rgba(8,16,26,.9), rgba(8,16,26,.65)); border-bottom:1px solid #1d2938}
        .wrap{max-width:1100px; margin:0 auto; padding:14px var(--pad)}
        h1{margin:0; font-size:1.35rem; letter-spacing:.2px}
        .sub{color:var(--muted); font-size:.95rem}

        .toolbar{display:grid; gap:10px; grid-template-columns:1fr; padding:12px var(--pad); background:var(--panel); border-bottom:1px solid #1d2938}
        @media (min-width:900px){ .toolbar{grid-template-columns: 1fr auto auto auto} }
        .toolbar .group{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
        .toolbar input[type="search"], select{background:#0b1420; color:var(--text); border:1px solid #1c2a3b; border-radius:10px; padding:10px 12px; outline:none; min-width:220px}
        .toolbar button, .chip{border:1px solid #26405f}
        .toolbar button{background:#102235; color:var(--text); padding:10px 12px; border-radius:10px; cursor:pointer}
        .toolbar button:hover{filter:brightness(1.1)}

        main{max-width:1100px; margin:20px auto; padding:0 var(--pad) 80px}
        .grid{display:grid; gap:14px}
        @media (min-width:800px){ .grid{grid-template-columns:repeat(2,1fr)} }
        @media (min-width:1100px){ .grid{grid-template-columns:repeat(3,1fr)} }

        .card{background:var(--card); border:1px solid #1c2a3b; border-radius:var(--radius); padding:16px; box-shadow:var(--shadow); position:relative; overflow:hidden}
        .type{font-size:.75rem; text-transform:uppercase; letter-spacing:.12em; color:var(--muted)}
        .title{margin:.15rem 0 .2rem; font-weight:650; font-size:1.05rem}
        .meta{font-size:.9rem; color:var(--muted)}
        .desc{margin:.6rem 0; color:#d6e2ee}
        .examples{margin:.6rem 0}
        .examples summary{cursor:pointer; color:var(--acc)}
        ul{margin:.35rem 0 .1rem .95rem}

        .chips{display:flex; gap:6px; flex-wrap:wrap; margin:.4rem 0}
        .chip{display:inline-flex; align-items:center; gap:6px; padding:6px 9px; border-radius:999px; background:var(--chip); color:#bcd2e6; font-size:.82rem}
        .chip .dot{width:7px; height:7px; border-radius:50%}

        .links a{display:inline-block; margin-right:10px; margin-top:6px; color:var(--acc); text-decoration:none}
        .links a:hover{text-decoration:underline}

        .legend{display:flex; flex-wrap:wrap; gap:8px}
        .legend .chip{opacity:.9}

        .stance{position:absolute; top:10px; right:10px; display:flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; font-size:.82rem; border:1px solid #26405f}
        .stance.claim{background:#112a1c; color:#b7f4c5; border-color:#214f33}
        .stance.debunk{background:#2a1411; color:#ffd1c7; border-color:#5a2a20}

        .pop{display:flex; align-items:center; gap:8px; margin-top:.4rem}
        .bar{flex:1; height:8px; background:#0b1420; border:1px solid #1c2a3b; border-radius:999px; overflow:hidden}
        .bar > span{display:block; height:100%; background:linear-gradient(90deg, #6fb1ff, #9be37a)}
        .pop .val{font-size:.8rem; color:var(--muted)}

        footer{max-width:1100px; margin:40px auto; padding:0 var(--pad) 40px; color:var(--muted)}
    </style>
</head>
<body>
<header>
    <div class="wrap">
        <h1 id="siteTitle">Каталог: цензура, этика и политика в науке</h1>
        <div id="siteDesc" class="sub">Все тексты и настройки берутся из внешнего JSON-файла.</div>
    </div>
</header>

<section class="toolbar">
    <div class="group">
        <input id="q" type="search" placeholder="Поиск: название, автор, пример…" />
        <select id="type">
            <option value="all">Все типы</option>
            <option value="book">Книги</option>
            <option value="article">Статьи/исследования</option>
            <option value="video">Видео/фильмы</option>
        </select>
        <select id="sort">
            <option value="relevance">Сортировка: релевантность</option>
            <option value="pop_desc">По популярности</option>
            <option value="year_desc">Сначала новые</option>
            <option value="year_asc">Сначала старые</option>
            <option value="title_asc">По названию (А→Я)</option>
        </select>
        <button id="reset">Сброс</button>
    </div>
    <div class="group" id="topicChips"></div>
    <div class="group legend" id="legend"></div>
</section>

<main>
    <div id="results" class="grid" aria-live="polite"></div>
</main>

<footer>
    <div class="wrap" id="footerNote">Данные загружаются из внешнего JSON-файла.</div>
</footer>


<script>
    // --- Helpers ---
    const $ = sel => document.querySelector(sel);
    const el = (tag, cls) => { const n=document.createElement(tag); if(cls) n.className=cls; return n; };
    const norm = s => (s||"").toString().toLowerCase();
    const allItems = d => [ ...(d.books||[]), ...(d.articles||[]), ...(d.videos||[]) ];

    let DATA;

    // Build domain legend from palette
    function renderLegend(){
      const wrap = $('#legend');
      wrap.innerHTML = '';
      const dom = DATA.palette?.domains || {};
      Object.entries(dom).forEach(([k,color])=>{
        const chip = el('span','chip');
        chip.innerHTML = `<span class="dot" style="background:${color}"></span>${k}`;
        wrap.appendChild(chip);
      });
    }

    function collectTopics(items){
      const t = new Set();
      items.forEach(x => (x.topics||[]).forEach(t.add, t));
      return Array.from(t).sort((a,b)=>a.localeCompare(b,'ru'));
    }

    function renderTopicChips(items){
      const wrap = $("#topicChips");
      wrap.innerHTML = "<span class=type>Темы:</span>";
      collectTopics(items).forEach(topic=>{
        const c = el('button','chip');
        c.type='button';
        const color = DATA.palette?.domains?.[topic];
        c.innerHTML = `<span class=dot style="background:${color||'#6fb1ff'}"></span>${topic}`;
        c.onclick = ()=>{ c.classList.toggle('active'); update(); };
        wrap.appendChild(c);
      });
      if(!wrap.children.length){ wrap.textContent = "Темы появятся после загрузки данных"; }
    }

    function stanceBadge(item){
      const st = (DATA.palette?.stance||{});
      const meta = st[item.stance] || {label:'', icon:''};
      const b = el('div','stance ' + (item.stance||''));
      b.textContent = `${meta.icon||''} ${meta.label||''}`.trim();
      return b;
    }

    function popBar(val){
      const box = el('div','pop');
      const bar = el('div','bar');
      const fill = el('span'); fill.style.width = Math.max(0, Math.min(100, +val||0)) + '%';
      bar.appendChild(fill);
      const v = el('span','val'); v.textContent = `популярность: ${val ?? 0}`;
      box.appendChild(bar); box.appendChild(v);
      return box;
    }

    function domainChips(item){
      const chips = el('div','chips');
      (item.topics||[]).forEach(t=>{
        const ch=el('span','chip');
        const color = DATA.palette?.domains?.[t];
        ch.innerHTML=`<span class="dot" style="background:${color||'#6fb1ff'}"></span>${t}`;
        chips.appendChild(ch);
      });
      return chips;
    }

    function counterLinks(item){
      if(!item.counter_ids || !item.counter_ids.length) return null;
      const wrap = el('div','links');
      const label = el('span','meta'); label.textContent = 'Контраргументы: ';
      wrap.appendChild(label);
      item.counter_ids.forEach(id=>{
        const found = allItems(DATA).find(x=>x.id===id);
        if(found){
          const a = el('a'); a.href = `#${found.id}`; a.textContent = found.title; a.addEventListener('click', e=>{ e.preventDefault(); const t = document.getElementById(found.id); if(t){ t.scrollIntoView({behavior:'smooth', block:'center'}); t.animate([{outline:'2px solid #6fb1ff'},{outline:'none'}],{duration:1200}); }});
          wrap.appendChild(a);
        }
      });
      return wrap;
    }

    function card(item){
      const c = el('article','card'); c.id = item.id;
      c.appendChild(stanceBadge(item));
      c.innerHTML += `
        <div class="type">${ item.type === 'book' ? 'Книга' : item.type === 'article' ? 'Статья/исследование' : 'Видео/фильм' }</div>
        <div class="title">${item.title}</div>
        <div class="meta">${ (item.authors||[]).join(', ') } ${ item.year? ' • '+item.year: ''}</div>
        <div class="desc">${ item.summary || ''}</div>
      `;
      c.appendChild(popBar(item.popularity));
      if(item.examples && item.examples.length){
        const det = el('details','examples');
        const sum = el('summary'); sum.textContent = 'Примеры и кейсы';
        const ul = el('ul');
        item.examples.forEach(e=>{ const li=el('li'); li.innerHTML = `<strong>${e.topic}:</strong> ${e.text}`; ul.appendChild(li); });
        det.appendChild(sum); det.appendChild(ul); c.appendChild(det);
      }
      c.appendChild(domainChips(item));
      if(item.links && item.links.length){
        const links = el('div','links');
        item.links.forEach(l=>{ const a=el('a'); a.href=l.url; a.target='_blank'; a.rel='noopener noreferrer'; a.textContent=l.label||'Ссылка'; links.appendChild(a); });
        c.appendChild(links);
      }
      const counters = counterLinks(item); if(counters) c.appendChild(counters);
      if(item.recommended_for && item.recommended_for.length){
        const rec = el('div','meta');
        rec.innerHTML = `Рекомендуется для: ${item.recommended_for.join(', ')}`;
        c.appendChild(rec);
      }
      return c;
    }

    function score(item, q){
      if(!q) return 0;
      const hay = [item.title, (item.authors||[]).join(' '), item.summary, ...(item.examples||[]).map(e=>e.text)].map(norm).join(' \n ');
      const terms = norm(q).split(/\s+/).filter(Boolean);
      let s = 0; terms.forEach(t=>{ if(hay.includes(t)) s += 1; });
      return -s; // для sort: меньше лучше
    }

    function getActiveTopics(){
      return Array.from(document.querySelectorAll('#topicChips .chip.active')).map(b=>b.textContent.trim());
    }

    function update(){
      const q = $('#q').value.trim();
      const type = $('#type').value;
      const sort = $('#sort').value;

      let items = allItems(DATA);
      if(type !== 'all') items = items.filter(x=>x.type===type);
      const activeTopics = new Set(getActiveTopics());
      if(activeTopics.size){
        items = items.filter(x => (x.topics||[]).some(t=>activeTopics.has(t)));
      }
      if(q){
        const qn = norm(q);
        items = items.filter(x=>{
          const hay = [x.title, (x.authors||[]).join(' '), x.summary, ...(x.examples||[]).map(e=>`${e.topic} ${e.text}`)].join(' \n ').toLowerCase();
          return qn.split(/\s+/).every(t=>hay.includes(t));
        });
      }
      if(sort==='year_desc') items.sort((a,b)=>(b.year||0)-(a.year||0));
      else if(sort==='year_asc') items.sort((a,b)=>(a.year||0)-(b.year||0));
      else if(sort==='title_asc') items.sort((a,b)=>a.title.localeCompare(b.title,'ru'));
      else if(sort==='pop_desc') items.sort((a,b)=>(b.popularity||0)-(a.popularity||0));
      else if(sort==='relevance') items.sort((a,b)=> score(a,q)-score(b,q));

      const root = $('#results');
      root.innerHTML = '';
      if(!items.length){
        const empty = el('div','meta'); empty.textContent = 'Ничего не найдено. Измените фильтры.'; root.appendChild(empty); return;
      }
      items.forEach(i=> root.appendChild(card(i)));
    }

    // Load data and init
    fetch('catalog.json')
      .then(r => r.json())
      .then(json => {
        DATA = json;

        $('#siteTitle').textContent = DATA.site?.title || $('#siteTitle').textContent;
        $('#siteDesc').textContent  = DATA.site?.description || $('#siteDesc').textContent;
        $('#footerNote').textContent= DATA.site?.footer || $('#footerNote').textContent;

        renderLegend();
        renderTopicChips(allItems(DATA));
        update();

        document.getElementById('reset').addEventListener('click', ()=>{
          $('#q').value=''; $('#type').value='all'; $('#sort').value='relevance';
          document.querySelectorAll('#topicChips .chip.active').forEach(b=>b.classList.remove('active'));
          update();
        });

        ['q','type','sort'].forEach(id=> document.getElementById(id).addEventListener('input', update));
      });
</script>
</body>
</html>
